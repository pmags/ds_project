<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Stage 4 Modeling | R Notebook</title>
  <meta name="description" content="Stage 4 Modeling | R Notebook" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Stage 4 Modeling | R Notebook" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Stage 4 Modeling | R Notebook" />
  
  
  

<meta name="author" content="Pedro Miguel de Sousa Magalhães" />


<meta name="date" content="2022-01-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-transformations.html"/>
<link rel="next" href="evaluation-and-conclusion.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Intro Data Science: Long Project</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="business-understanding.html"><a href="business-understanding.html"><i class="fa fa-check"></i><b>1</b> Business Understanding</a>
<ul>
<li class="chapter" data-level="1.1" data-path="business-understanding.html"><a href="business-understanding.html#business-objectives"><i class="fa fa-check"></i><b>1.1</b> Business objectives</a></li>
<li class="chapter" data-level="1.2" data-path="business-understanding.html"><a href="business-understanding.html#assess-situation"><i class="fa fa-check"></i><b>1.2</b> Assess Situation</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="business-understanding.html"><a href="business-understanding.html#hardware-and-environment-special-needs"><i class="fa fa-check"></i><b>1.2.1</b> Hardware and environment special needs</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="business-understanding.html"><a href="business-understanding.html#data-mining-goals"><i class="fa fa-check"></i><b>1.3</b> Data Mining Goals</a></li>
<li class="chapter" data-level="1.4" data-path="business-understanding.html"><a href="business-understanding.html#project-plan"><i class="fa fa-check"></i><b>1.4</b> Project Plan</a></li>
<li class="chapter" data-level="1.5" data-path="business-understanding.html"><a href="business-understanding.html#terms"><i class="fa fa-check"></i><b>1.5</b> Terms</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html"><i class="fa fa-check"></i><b>2</b> Data aquisition and understanding</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#description"><i class="fa fa-check"></i><b>2.1</b> Description</a></li>
<li class="chapter" data-level="2.2" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#irrelevant-or-technical-information"><i class="fa fa-check"></i><b>2.2</b> Irrelevant or technical information</a></li>
<li class="chapter" data-level="2.3" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#target-variable-to-buy-or-not-to-buy"><i class="fa fa-check"></i><b>2.3</b> Target Variable: To buy or not to buy …</a></li>
<li class="chapter" data-level="2.4" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#customer-behavior-features"><i class="fa fa-check"></i><b>2.4</b> Customer Behavior Features</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#duration"><i class="fa fa-check"></i><b>2.4.1</b> Duration</a></li>
<li class="chapter" data-level="2.4.2" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#page-view-quantity"><i class="fa fa-check"></i><b>2.4.2</b> Page View Quantity</a></li>
<li class="chapter" data-level="2.4.3" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#product-pages-unique-page-views"><i class="fa fa-check"></i><b>2.4.3</b> Product Pages unique page views</a></li>
<li class="chapter" data-level="2.4.4" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#designer-browsing-unique-page-views"><i class="fa fa-check"></i><b>2.4.4</b> Designer Browsing unique page views</a></li>
<li class="chapter" data-level="2.4.5" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#products-categories-unique-id"><i class="fa fa-check"></i><b>2.4.5</b> Products categories unique id</a></li>
<li class="chapter" data-level="2.4.6" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#potential-ideas-for-feature-engineering-which-were-not-implemented"><i class="fa fa-check"></i><b>2.4.6</b> Potential ideas for feature engineering which were not implemented</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#customer-journey-related-features"><i class="fa fa-check"></i><b>2.5</b> Customer Journey related Features</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#device-group"><i class="fa fa-check"></i><b>2.5.1</b> Device Group</a></li>
<li class="chapter" data-level="2.5.2" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#platform"><i class="fa fa-check"></i><b>2.5.2</b> Platform</a></li>
<li class="chapter" data-level="2.5.3" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#journey-milestones"><i class="fa fa-check"></i><b>2.5.3</b> Journey milestones</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#client-segment-related-features"><i class="fa fa-check"></i><b>2.6</b> Client Segment related Features</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#customer-type"><i class="fa fa-check"></i><b>2.6.1</b> Customer type</a></li>
<li class="chapter" data-level="2.6.2" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#segment"><i class="fa fa-check"></i><b>2.6.2</b> Segment</a></li>
<li class="chapter" data-level="2.6.3" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#visitor-type"><i class="fa fa-check"></i><b>2.6.3</b> Visitor type</a></li>
<li class="chapter" data-level="2.6.4" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#is-subscribed"><i class="fa fa-check"></i><b>2.6.4</b> Is subscribed</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#device-and-geography-related-features"><i class="fa fa-check"></i><b>2.7</b> Device and Geography related Features</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#browser-name"><i class="fa fa-check"></i><b>2.7.1</b> Browser name</a></li>
<li class="chapter" data-level="2.7.2" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#country"><i class="fa fa-check"></i><b>2.7.2</b> Country</a></li>
<li class="chapter" data-level="2.7.3" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#dealing-with-missing-data"><i class="fa fa-check"></i><b>2.7.3</b> Dealing with Missing Data</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="data-aquisition-and-understanding.html"><a href="data-aquisition-and-understanding.html#summary-of-findings"><i class="fa fa-check"></i><b>2.8</b> Summary of findings</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-transformations.html"><a href="data-transformations.html"><i class="fa fa-check"></i><b>3</b> Data transformations</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-transformations.html"><a href="data-transformations.html#summary-of-transformation-steps-identified-during-eda"><i class="fa fa-check"></i><b>3.1</b> Summary of transformation steps identified during EDA</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>4</b> Modeling</a>
<ul>
<li class="chapter" data-level="4.1" data-path="modeling.html"><a href="modeling.html#baseline"><i class="fa fa-check"></i><b>4.1</b> Baseline</a></li>
<li class="chapter" data-level="4.2" data-path="modeling.html"><a href="modeling.html#naive-bayes-classifier"><i class="fa fa-check"></i><b>4.2</b> Naive Bayes Classifier</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="modeling.html"><a href="modeling.html#initial-experiments"><i class="fa fa-check"></i><b>4.2.1</b> Initial experiments</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="modeling.html"><a href="modeling.html#logistic-regression"><i class="fa fa-check"></i><b>4.3</b> Logistic Regression</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="modeling.html"><a href="modeling.html#initial-experiments-1"><i class="fa fa-check"></i><b>4.3.1</b> Initial experiments</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="modeling.html"><a href="modeling.html#knn"><i class="fa fa-check"></i><b>4.4</b> Knn</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="modeling.html"><a href="modeling.html#initial-experiment"><i class="fa fa-check"></i><b>4.4.1</b> Initial experiment</a></li>
<li class="chapter" data-level="4.4.2" data-path="modeling.html"><a href="modeling.html#fitting-multiple-models-using-grid-search"><i class="fa fa-check"></i><b>4.4.2</b> Fitting multiple models using grid search</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="modeling.html"><a href="modeling.html#workflow-rpart"><i class="fa fa-check"></i><b>4.5</b> Workflow: Rpart</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="modeling.html"><a href="modeling.html#initial-experiment-1"><i class="fa fa-check"></i><b>4.5.1</b> Initial experiment</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="modeling.html"><a href="modeling.html#workflow-random-forest"><i class="fa fa-check"></i><b>4.6</b> Workflow: Random Forest</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="modeling.html"><a href="modeling.html#initial-experiment-2"><i class="fa fa-check"></i><b>4.6.1</b> Initial experiment</a></li>
<li class="chapter" data-level="4.6.2" data-path="modeling.html"><a href="modeling.html#fitting-multiple-models-using-grid-search-1"><i class="fa fa-check"></i><b>4.6.2</b> Fitting multiple models using grid search</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="modeling.html"><a href="modeling.html#workflow-single-layer-neural-network"><i class="fa fa-check"></i><b>4.7</b> Workflow: Single Layer Neural Network</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="modeling.html"><a href="modeling.html#initial-experiment-3"><i class="fa fa-check"></i><b>4.7.1</b> Initial experiment</a></li>
<li class="chapter" data-level="4.7.2" data-path="modeling.html"><a href="modeling.html#fitting-multiple-models-using-grid-search-2"><i class="fa fa-check"></i><b>4.7.2</b> Fitting multiple models using grid search</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="modeling.html"><a href="modeling.html#support-vector-machine"><i class="fa fa-check"></i><b>4.8</b> Support Vector Machine</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="modeling.html"><a href="modeling.html#initial-experience-linear-kernel"><i class="fa fa-check"></i><b>4.8.1</b> Initial experience: Linear Kernel</a></li>
<li class="chapter" data-level="4.8.2" data-path="modeling.html"><a href="modeling.html#fitting-multiple-models"><i class="fa fa-check"></i><b>4.8.2</b> Fitting multiple models</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="evaluation-and-conclusion.html"><a href="evaluation-and-conclusion.html"><i class="fa fa-check"></i><b>5</b> Evaluation and conclusion</a>
<ul>
<li class="chapter" data-level="5.1" data-path="evaluation-and-conclusion.html"><a href="evaluation-and-conclusion.html#next-steps."><i class="fa fa-check"></i><b>5.1</b> Next steps.</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Notebook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="modeling" class="section level1" number="4">
<h1><span class="header-section-number">Stage 4</span> Modeling</h1>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="modeling.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb82-2"><a href="modeling.html#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb82-3"><a href="modeling.html#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb82-4"><a href="modeling.html#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;keras&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:yardstick&#39;:
## 
##     get_weights</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="modeling.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb85-2"><a href="modeling.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(discrim)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;discrim&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dials&#39;:
## 
##     smoothness</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="modeling.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code></pre></div>
<pre><code>## Welcome! Want to learn more? See two factoextra-related books at https://goo.gl/ve3WBa</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="modeling.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cv 10 folds</span></span>
<span id="cb90-2"><a href="modeling.html#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="modeling.html#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb90-4"><a href="modeling.html#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To keep speed of processing no repeats will be used during resampling</span></span>
<span id="cb90-5"><a href="modeling.html#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="co"># folds &lt;- vfold_cv(balanced_data, v = 10, repeats = 5)</span></span>
<span id="cb90-6"><a href="modeling.html#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="modeling.html#cb90-7" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(balanced_data, <span class="at">v =</span> <span class="dv">10</span>)</span></code></pre></div>
<p>The following planning will be used for a list of candidate models:</p>
<ol style="list-style-type: decimal">
<li>A Model baseline will be defined and will be used to compare against other models</li>
<li>Define training and evaluation series. Using Cross Validation with 10 folds</li>
<li>Initial experiment using preprocessing workflow</li>
<li>When needed given this project objectives hyperparameters will be tuned</li>
<li>Retrain model with new hyperparameters</li>
<li>Model comparison</li>
</ol>
<p>Given the goals set for this project we shall focus on Accuracy and Auc ROC as metrics to compare models.</p>
<p>The initial experiment uses the preprocess schema and the default hyperparameters for each model.</p>
<div class="yellowbox">
<p>Given the name of the files available and since no more information is available, the subsquent teste will be done assuming that a test split was already made and the available information is only for trainning. Therefore, the cross validation resampling will be done over this training dataset.</p>
</div>
<div id="baseline" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Baseline</h2>
<p>Given its simplicity and flexibility a Naive Bayes classifier will be used as baseline for this project. The preprocess was set to a minimum in order to measure the impact it might have on the final output. The engine used for this algorithm does not accept missing data, therefore we did a 3nn imputation.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="modeling.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. specify the model</span></span>
<span id="cb91-2"><a href="modeling.html#cb91-2" aria-hidden="true" tabindex="-1"></a>naive_Bayes <span class="ot">&lt;-</span></span>
<span id="cb91-3"><a href="modeling.html#cb91-3" aria-hidden="true" tabindex="-1"></a>  discrim<span class="sc">::</span><span class="fu">naive_Bayes</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-4"><a href="modeling.html#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;klaR&#39;</span>)</span>
<span id="cb91-5"><a href="modeling.html#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="modeling.html#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. preprocessing </span></span>
<span id="cb91-7"><a href="modeling.html#cb91-7" aria-hidden="true" tabindex="-1"></a>preprocess <span class="ot">&lt;-</span> </span>
<span id="cb91-8"><a href="modeling.html#cb91-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(bought <span class="sc">~</span> ., <span class="at">data =</span> balanced_data) <span class="sc">%&gt;%</span></span>
<span id="cb91-9"><a href="modeling.html#cb91-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb91-10"><a href="modeling.html#cb91-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb91-11"><a href="modeling.html#cb91-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb91-12"><a href="modeling.html#cb91-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-13"><a href="modeling.html#cb91-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-14"><a href="modeling.html#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 3, Buildworkflow</span></span>
<span id="cb91-15"><a href="modeling.html#cb91-15" aria-hidden="true" tabindex="-1"></a>baseline_wflow <span class="ot">&lt;-</span> </span>
<span id="cb91-16"><a href="modeling.html#cb91-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb91-17"><a href="modeling.html#cb91-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(naive_Bayes) <span class="sc">%&gt;%</span> </span>
<span id="cb91-18"><a href="modeling.html#cb91-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preprocess)</span>
<span id="cb91-19"><a href="modeling.html#cb91-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-20"><a href="modeling.html#cb91-20" aria-hidden="true" tabindex="-1"></a><span class="co">#4. Fit model</span></span>
<span id="cb91-21"><a href="modeling.html#cb91-21" aria-hidden="true" tabindex="-1"></a>fit_control <span class="ot">&lt;-</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-22"><a href="modeling.html#cb91-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-23"><a href="modeling.html#cb91-23" aria-hidden="true" tabindex="-1"></a>baseline_fit <span class="ot">&lt;-</span> </span>
<span id="cb91-24"><a href="modeling.html#cb91-24" aria-hidden="true" tabindex="-1"></a>  baseline_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb91-25"><a href="modeling.html#cb91-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(folds, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">control =</span> fit_control)</span></code></pre></div>
<pre><code>## Warning: The `...` are not used in this function but one or more objects were
## passed: &#39;verbose&#39;</code></pre>
<pre><code>## ! Fold01: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold02: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold03: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold04: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold05: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold06: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold07: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold08: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold09: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<pre><code>## ! Fold10: preprocessor 1/1, model 1/1 (predictions): Numerical 0 probability for a...</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="modeling.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co">#5. Performance metrics over the validation set</span></span>
<span id="cb103-2"><a href="modeling.html#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(baseline_fit)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   .metric  .estimator  mean     n std_err .config             
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;               
## 1 accuracy binary     0.816    10 0.00246 Preprocessor1_Model1
## 2 roc_auc  binary     0.914    10 0.00150 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="modeling.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat_resampled</span>(baseline_fit)</span></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##   Prediction Truth  Freq
##   &lt;fct&gt;      &lt;fct&gt; &lt;dbl&gt;
## 1 0          0      689.
## 2 0          1      183.
## 3 1          0      111.
## 4 1          1      617.</code></pre>

</div>
<div id="naive-bayes-classifier" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Naive Bayes Classifier</h2>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="modeling.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb107-2"><a href="modeling.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb107-3"><a href="modeling.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb107-4"><a href="modeling.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb107-5"><a href="modeling.html#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb107-6"><a href="modeling.html#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(discrim)</span>
<span id="cb107-7"><a href="modeling.html#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="modeling.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cv 10 folds</span></span>
<span id="cb108-2"><a href="modeling.html#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="modeling.html#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb108-4"><a href="modeling.html#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To keep speed of processing no repeats will be used during resampling</span></span>
<span id="cb108-5"><a href="modeling.html#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co"># folds &lt;- vfold_cv(balanced_data, v = 10, repeats = 5)</span></span>
<span id="cb108-6"><a href="modeling.html#cb108-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-7"><a href="modeling.html#cb108-7" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(balanced_data, <span class="at">v =</span> <span class="dv">10</span>)</span></code></pre></div>
<div id="initial-experiments" class="section level3" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Initial experiments</h3>
<p>Following the baseline but introducing pre-processing</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="modeling.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. specify the model</span></span>
<span id="cb109-2"><a href="modeling.html#cb109-2" aria-hidden="true" tabindex="-1"></a>naive_Bayes <span class="ot">&lt;-</span></span>
<span id="cb109-3"><a href="modeling.html#cb109-3" aria-hidden="true" tabindex="-1"></a>  discrim<span class="sc">::</span><span class="fu">naive_Bayes</span>() <span class="sc">%&gt;%</span></span>
<span id="cb109-4"><a href="modeling.html#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;klaR&#39;</span>)</span>
<span id="cb109-5"><a href="modeling.html#cb109-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-6"><a href="modeling.html#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. preprocessing </span></span>
<span id="cb109-7"><a href="modeling.html#cb109-7" aria-hidden="true" tabindex="-1"></a>preprocess <span class="ot">&lt;-</span> </span>
<span id="cb109-8"><a href="modeling.html#cb109-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(bought <span class="sc">~</span> . , <span class="at">data =</span> balanced_data) <span class="sc">%&gt;%</span></span>
<span id="cb109-9"><a href="modeling.html#cb109-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ratio</span>(<span class="fu">starts_with</span>(<span class="st">&quot;unique_&quot;</span>), <span class="at">denom =</span> <span class="fu">denom_vars</span>(view_qty)) <span class="sc">%&gt;%</span> </span>
<span id="cb109-10"><a href="modeling.html#cb109-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(device_group, unique_product_qty, unique_browse_designer_qty, </span>
<span id="cb109-11"><a href="modeling.html#cb109-11" aria-hidden="true" tabindex="-1"></a>          unique_browse_category_qty) <span class="sc">%&gt;%</span> </span>
<span id="cb109-12"><a href="modeling.html#cb109-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(country, browser_name, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb109-13"><a href="modeling.html#cb109-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(view_qty) <span class="sc">%&gt;%</span></span>
<span id="cb109-14"><a href="modeling.html#cb109-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter</span>(</span>
<span id="cb109-15"><a href="modeling.html#cb109-15" aria-hidden="true" tabindex="-1"></a>    duration <span class="sc">&lt;</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span>,</span>
<span id="cb109-16"><a href="modeling.html#cb109-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>((view_qty <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (duration <span class="sc">&lt;=</span> <span class="dv">2</span>))</span>
<span id="cb109-17"><a href="modeling.html#cb109-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb109-18"><a href="modeling.html#cb109-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb109-19"><a href="modeling.html#cb109-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb109-20"><a href="modeling.html#cb109-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">&quot;has_&quot;</span>), <span class="at">num_comp =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb109-21"><a href="modeling.html#cb109-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">5</span>) </span>
<span id="cb109-22"><a href="modeling.html#cb109-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-23"><a href="modeling.html#cb109-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-24"><a href="modeling.html#cb109-24" aria-hidden="true" tabindex="-1"></a>preprocess_logit_nn <span class="ot">&lt;-</span> </span>
<span id="cb109-25"><a href="modeling.html#cb109-25" aria-hidden="true" tabindex="-1"></a>  preprocess <span class="sc">%&gt;%</span> </span>
<span id="cb109-26"><a href="modeling.html#cb109-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb109-27"><a href="modeling.html#cb109-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb109-28"><a href="modeling.html#cb109-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-29"><a href="modeling.html#cb109-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 3, Buildworkflow</span></span>
<span id="cb109-30"><a href="modeling.html#cb109-30" aria-hidden="true" tabindex="-1"></a>nbayes_wflow <span class="ot">&lt;-</span> </span>
<span id="cb109-31"><a href="modeling.html#cb109-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb109-32"><a href="modeling.html#cb109-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(naive_Bayes) <span class="sc">%&gt;%</span> </span>
<span id="cb109-33"><a href="modeling.html#cb109-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preprocess_logit_nn)</span>
<span id="cb109-34"><a href="modeling.html#cb109-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-35"><a href="modeling.html#cb109-35" aria-hidden="true" tabindex="-1"></a><span class="co">#4. Fit model</span></span>
<span id="cb109-36"><a href="modeling.html#cb109-36" aria-hidden="true" tabindex="-1"></a>fit_control <span class="ot">&lt;-</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb109-37"><a href="modeling.html#cb109-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-38"><a href="modeling.html#cb109-38" aria-hidden="true" tabindex="-1"></a>nbayes_fit <span class="ot">&lt;-</span> </span>
<span id="cb109-39"><a href="modeling.html#cb109-39" aria-hidden="true" tabindex="-1"></a>  nbayes_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb109-40"><a href="modeling.html#cb109-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(folds, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">control =</span> fit_control)</span></code></pre></div>
<pre><code>## Warning: The `...` are not used in this function but one or more objects were
## passed: &#39;verbose&#39;</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="modeling.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">#5. Performance metrics over the validation set</span></span>
<span id="cb111-2"><a href="modeling.html#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(nbayes_fit)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   .metric  .estimator  mean     n std_err .config             
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;               
## 1 accuracy binary     0.872    10 0.00428 Preprocessor1_Model1
## 2 roc_auc  binary     0.943    10 0.00195 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="modeling.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># export files</span></span>
<span id="cb113-2"><a href="modeling.html#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="modeling.html#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(nbayes_fit, <span class="at">file =</span> <span class="st">&quot;_models/nbayes_fit.RData&quot;</span>)</span></code></pre></div>

</div>
</div>
<div id="logistic-regression" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Logistic Regression</h2>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="modeling.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb114-2"><a href="modeling.html#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb114-3"><a href="modeling.html#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb114-4"><a href="modeling.html#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb114-5"><a href="modeling.html#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb114-6"><a href="modeling.html#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(discrim)</span>
<span id="cb114-7"><a href="modeling.html#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code></pre></div>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="modeling.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cv 10 folds</span></span>
<span id="cb115-2"><a href="modeling.html#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="modeling.html#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb115-4"><a href="modeling.html#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To keep speed of processing no repeats will be used during resampling</span></span>
<span id="cb115-5"><a href="modeling.html#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="co"># folds &lt;- vfold_cv(balanced_data, v = 10, repeats = 5)</span></span>
<span id="cb115-6"><a href="modeling.html#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="modeling.html#cb115-7" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(balanced_data, <span class="at">v =</span> <span class="dv">10</span>)</span></code></pre></div>
<div id="initial-experiments-1" class="section level3" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Initial experiments</h3>
<p>Using library glml</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="modeling.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. specify the model</span></span>
<span id="cb116-2"><a href="modeling.html#cb116-2" aria-hidden="true" tabindex="-1"></a>logistic_reg_glm_spec <span class="ot">&lt;-</span></span>
<span id="cb116-3"><a href="modeling.html#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb116-4"><a href="modeling.html#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;glm&#39;</span>) </span>
<span id="cb116-5"><a href="modeling.html#cb116-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-6"><a href="modeling.html#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. preprocessing </span></span>
<span id="cb116-7"><a href="modeling.html#cb116-7" aria-hidden="true" tabindex="-1"></a>preprocess <span class="ot">&lt;-</span> </span>
<span id="cb116-8"><a href="modeling.html#cb116-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(bought <span class="sc">~</span> . , <span class="at">data =</span> balanced_data) <span class="sc">%&gt;%</span></span>
<span id="cb116-9"><a href="modeling.html#cb116-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ratio</span>(<span class="fu">starts_with</span>(<span class="st">&quot;unique_&quot;</span>), <span class="at">denom =</span> <span class="fu">denom_vars</span>(view_qty)) <span class="sc">%&gt;%</span> </span>
<span id="cb116-10"><a href="modeling.html#cb116-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(device_group, unique_product_qty, unique_browse_designer_qty, </span>
<span id="cb116-11"><a href="modeling.html#cb116-11" aria-hidden="true" tabindex="-1"></a>          unique_browse_category_qty) <span class="sc">%&gt;%</span> </span>
<span id="cb116-12"><a href="modeling.html#cb116-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(country, browser_name, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-13"><a href="modeling.html#cb116-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(view_qty) <span class="sc">%&gt;%</span></span>
<span id="cb116-14"><a href="modeling.html#cb116-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter</span>(</span>
<span id="cb116-15"><a href="modeling.html#cb116-15" aria-hidden="true" tabindex="-1"></a>    duration <span class="sc">&lt;</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span>,</span>
<span id="cb116-16"><a href="modeling.html#cb116-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>((view_qty <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (duration <span class="sc">&lt;=</span> <span class="dv">2</span>))</span>
<span id="cb116-17"><a href="modeling.html#cb116-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb116-18"><a href="modeling.html#cb116-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb116-19"><a href="modeling.html#cb116-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb116-20"><a href="modeling.html#cb116-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">&quot;has_&quot;</span>), <span class="at">num_comp =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-21"><a href="modeling.html#cb116-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">5</span>) </span>
<span id="cb116-22"><a href="modeling.html#cb116-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-23"><a href="modeling.html#cb116-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-24"><a href="modeling.html#cb116-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-25"><a href="modeling.html#cb116-25" aria-hidden="true" tabindex="-1"></a>preprocess_logit_nn <span class="ot">&lt;-</span> </span>
<span id="cb116-26"><a href="modeling.html#cb116-26" aria-hidden="true" tabindex="-1"></a>  preprocess <span class="sc">%&gt;%</span> </span>
<span id="cb116-27"><a href="modeling.html#cb116-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb116-28"><a href="modeling.html#cb116-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb116-29"><a href="modeling.html#cb116-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-30"><a href="modeling.html#cb116-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 3, Buildworkflow</span></span>
<span id="cb116-31"><a href="modeling.html#cb116-31" aria-hidden="true" tabindex="-1"></a>logit_wflow <span class="ot">&lt;-</span> </span>
<span id="cb116-32"><a href="modeling.html#cb116-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb116-33"><a href="modeling.html#cb116-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(logistic_reg_glm_spec) <span class="sc">%&gt;%</span> </span>
<span id="cb116-34"><a href="modeling.html#cb116-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preprocess_logit_nn)</span>
<span id="cb116-35"><a href="modeling.html#cb116-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-36"><a href="modeling.html#cb116-36" aria-hidden="true" tabindex="-1"></a><span class="co">#4. Fit model</span></span>
<span id="cb116-37"><a href="modeling.html#cb116-37" aria-hidden="true" tabindex="-1"></a>fit_control <span class="ot">&lt;-</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb116-38"><a href="modeling.html#cb116-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-39"><a href="modeling.html#cb116-39" aria-hidden="true" tabindex="-1"></a>logit_fit <span class="ot">&lt;-</span> </span>
<span id="cb116-40"><a href="modeling.html#cb116-40" aria-hidden="true" tabindex="-1"></a>  logit_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb116-41"><a href="modeling.html#cb116-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(folds, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">control =</span> fit_control)</span></code></pre></div>
<pre><code>## Warning: The `...` are not used in this function but one or more objects were
## passed: &#39;verbose&#39;</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="modeling.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co">#5. Performance metrics over the validation set</span></span>
<span id="cb118-2"><a href="modeling.html#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(logit_fit)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   .metric  .estimator  mean     n std_err .config             
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;               
## 1 accuracy binary     0.823    10 0.00279 Preprocessor1_Model1
## 2 roc_auc  binary     0.920    10 0.00202 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="modeling.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># export files</span></span>
<span id="cb120-2"><a href="modeling.html#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="modeling.html#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(logit_fit, <span class="at">file =</span> <span class="st">&quot;_models/logit_fit.RData&quot;</span>)</span></code></pre></div>

</div>
</div>
<div id="knn" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> Knn</h2>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="modeling.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb121-2"><a href="modeling.html#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb121-3"><a href="modeling.html#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb121-4"><a href="modeling.html#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb121-5"><a href="modeling.html#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(discrim)</span>
<span id="cb121-6"><a href="modeling.html#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code></pre></div>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="modeling.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cv 10 folds</span></span>
<span id="cb122-2"><a href="modeling.html#cb122-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-3"><a href="modeling.html#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb122-4"><a href="modeling.html#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To keep speed of processing no repeats will be used during resampling</span></span>
<span id="cb122-5"><a href="modeling.html#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="co"># folds &lt;- vfold_cv(balanced_data, v = 10, repeats = 5)</span></span>
<span id="cb122-6"><a href="modeling.html#cb122-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-7"><a href="modeling.html#cb122-7" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(balanced_data, <span class="at">v =</span> <span class="dv">10</span>)</span></code></pre></div>
<div id="initial-experiment" class="section level3" number="4.4.1">
<h3><span class="header-section-number">4.4.1</span> Initial experiment</h3>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="modeling.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. specify the model</span></span>
<span id="cb123-2"><a href="modeling.html#cb123-2" aria-hidden="true" tabindex="-1"></a>kknn <span class="ot">&lt;-</span></span>
<span id="cb123-3"><a href="modeling.html#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb123-4"><a href="modeling.html#cb123-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;kknn&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb123-5"><a href="modeling.html#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&#39;classification&#39;</span>)</span>
<span id="cb123-6"><a href="modeling.html#cb123-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-7"><a href="modeling.html#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. preprocessing </span></span>
<span id="cb123-8"><a href="modeling.html#cb123-8" aria-hidden="true" tabindex="-1"></a>preprocess <span class="ot">&lt;-</span> </span>
<span id="cb123-9"><a href="modeling.html#cb123-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(bought <span class="sc">~</span> . , <span class="at">data =</span> balanced_data) <span class="sc">%&gt;%</span></span>
<span id="cb123-10"><a href="modeling.html#cb123-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ratio</span>(<span class="fu">starts_with</span>(<span class="st">&quot;unique_&quot;</span>), <span class="at">denom =</span> <span class="fu">denom_vars</span>(view_qty)) <span class="sc">%&gt;%</span> </span>
<span id="cb123-11"><a href="modeling.html#cb123-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(device_group, unique_product_qty, unique_browse_designer_qty, </span>
<span id="cb123-12"><a href="modeling.html#cb123-12" aria-hidden="true" tabindex="-1"></a>          unique_browse_category_qty) <span class="sc">%&gt;%</span> </span>
<span id="cb123-13"><a href="modeling.html#cb123-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(country, browser_name, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-14"><a href="modeling.html#cb123-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(view_qty) <span class="sc">%&gt;%</span></span>
<span id="cb123-15"><a href="modeling.html#cb123-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter</span>(</span>
<span id="cb123-16"><a href="modeling.html#cb123-16" aria-hidden="true" tabindex="-1"></a>    duration <span class="sc">&lt;</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span>,</span>
<span id="cb123-17"><a href="modeling.html#cb123-17" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>((view_qty <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (duration <span class="sc">&lt;=</span> <span class="dv">2</span>))</span>
<span id="cb123-18"><a href="modeling.html#cb123-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb123-19"><a href="modeling.html#cb123-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb123-20"><a href="modeling.html#cb123-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb123-21"><a href="modeling.html#cb123-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">&quot;has_&quot;</span>), <span class="at">num_comp =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-22"><a href="modeling.html#cb123-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">5</span>) </span>
<span id="cb123-23"><a href="modeling.html#cb123-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-24"><a href="modeling.html#cb123-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-25"><a href="modeling.html#cb123-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-26"><a href="modeling.html#cb123-26" aria-hidden="true" tabindex="-1"></a>preprocess_logit_nn <span class="ot">&lt;-</span> </span>
<span id="cb123-27"><a href="modeling.html#cb123-27" aria-hidden="true" tabindex="-1"></a>  preprocess <span class="sc">%&gt;%</span> </span>
<span id="cb123-28"><a href="modeling.html#cb123-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb123-29"><a href="modeling.html#cb123-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) </span>
<span id="cb123-30"><a href="modeling.html#cb123-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-31"><a href="modeling.html#cb123-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 3, Buildworkflow</span></span>
<span id="cb123-32"><a href="modeling.html#cb123-32" aria-hidden="true" tabindex="-1"></a>kknn_wflow <span class="ot">&lt;-</span> </span>
<span id="cb123-33"><a href="modeling.html#cb123-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-34"><a href="modeling.html#cb123-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(kknn) <span class="sc">%&gt;%</span> </span>
<span id="cb123-35"><a href="modeling.html#cb123-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preprocess_logit_nn)</span>
<span id="cb123-36"><a href="modeling.html#cb123-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-37"><a href="modeling.html#cb123-37" aria-hidden="true" tabindex="-1"></a><span class="co">#4. Fit model</span></span>
<span id="cb123-38"><a href="modeling.html#cb123-38" aria-hidden="true" tabindex="-1"></a>fit_control <span class="ot">&lt;-</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb123-39"><a href="modeling.html#cb123-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-40"><a href="modeling.html#cb123-40" aria-hidden="true" tabindex="-1"></a>kknn_fit <span class="ot">&lt;-</span> </span>
<span id="cb123-41"><a href="modeling.html#cb123-41" aria-hidden="true" tabindex="-1"></a>  kknn_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb123-42"><a href="modeling.html#cb123-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(folds, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">control =</span> fit_control)</span></code></pre></div>
<pre><code>## Warning: The `...` are not used in this function but one or more objects were
## passed: &#39;verbose&#39;</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="modeling.html#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co">#5. Performance metrics over the validation set</span></span>
<span id="cb125-2"><a href="modeling.html#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(kknn_fit)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   .metric  .estimator  mean     n std_err .config             
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;               
## 1 accuracy binary     0.871    10 0.00269 Preprocessor1_Model1
## 2 roc_auc  binary     0.922    10 0.00220 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="modeling.html#cb127-1" aria-hidden="true" tabindex="-1"></a>kknn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb127-2"><a href="modeling.html#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb127-3"><a href="modeling.html#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb127-4"><a href="modeling.html#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(bought, .pred_0) <span class="sc">%&gt;%</span> </span>
<span id="cb127-5"><a href="modeling.html#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="dv">1</span><span class="sc">-</span> specificity, sensitivity, <span class="at">color =</span> id)) <span class="sc">+</span></span>
<span id="cb127-6"><a href="modeling.html#cb127-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">&quot;gray80&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb127-7"><a href="modeling.html#cb127-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb127-8"><a href="modeling.html#cb127-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>() <span class="sc">+</span></span>
<span id="cb127-9"><a href="modeling.html#cb127-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-94-1.png" width="672" /></p>
</div>
<div id="fitting-multiple-models-using-grid-search" class="section level3" number="4.4.2">
<h3><span class="header-section-number">4.4.2</span> Fitting multiple models using grid search</h3>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="modeling.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co">#1. list model to inject into workflow</span></span>
<span id="cb128-2"><a href="modeling.html#cb128-2" aria-hidden="true" tabindex="-1"></a>kknn_grid<span class="ot">&lt;-</span></span>
<span id="cb128-3"><a href="modeling.html#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb128-4"><a href="modeling.html#cb128-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;kknn&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb128-5"><a href="modeling.html#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&#39;classification&#39;</span>)</span>
<span id="cb128-6"><a href="modeling.html#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="modeling.html#cb128-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-8"><a href="modeling.html#cb128-8" aria-hidden="true" tabindex="-1"></a>models_flow <span class="ot">&lt;-</span> </span>
<span id="cb128-9"><a href="modeling.html#cb128-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_set</span>(</span>
<span id="cb128-10"><a href="modeling.html#cb128-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">recipe =</span> preprocess_logit_nn),</span>
<span id="cb128-11"><a href="modeling.html#cb128-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> <span class="fu">list</span>(kknn_grid),</span>
<span id="cb128-12"><a href="modeling.html#cb128-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cross =</span> <span class="cn">TRUE</span> </span>
<span id="cb128-13"><a href="modeling.html#cb128-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb128-14"><a href="modeling.html#cb128-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-15"><a href="modeling.html#cb128-15" aria-hidden="true" tabindex="-1"></a>kknn_wf_fit <span class="ot">&lt;-</span> </span>
<span id="cb128-16"><a href="modeling.html#cb128-16" aria-hidden="true" tabindex="-1"></a>  models_flow <span class="sc">%&gt;%</span></span>
<span id="cb128-17"><a href="modeling.html#cb128-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(</span>
<span id="cb128-18"><a href="modeling.html#cb128-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">fn =</span><span class="st">&quot;tune_grid&quot;</span>,</span>
<span id="cb128-19"><a href="modeling.html#cb128-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds,</span>
<span id="cb128-20"><a href="modeling.html#cb128-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="dv">10</span> ,</span>
<span id="cb128-21"><a href="modeling.html#cb128-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>roc_auc, yardstick<span class="sc">::</span>accuracy, yardstick<span class="sc">::</span>sens),</span>
<span id="cb128-22"><a href="modeling.html#cb128-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb128-23"><a href="modeling.html#cb128-23" aria-hidden="true" tabindex="-1"></a>    ) </span></code></pre></div>
<pre><code>## i 1 of 1 tuning:     recipe_nearest_neighbor</code></pre>
<pre><code>## v 1 of 1 tuning:     recipe_nearest_neighbor (4m 21.7s)</code></pre>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="modeling.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(kknn_wf_fit) <span class="sc">+</span></span>
<span id="cb131-2"><a href="modeling.html#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-96-1.png" width="672" /></p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="modeling.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># export files</span></span>
<span id="cb132-2"><a href="modeling.html#cb132-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-3"><a href="modeling.html#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(kknn_fit, <span class="at">file =</span> <span class="st">&quot;_models/kknn_fit.RData&quot;</span>)</span>
<span id="cb132-4"><a href="modeling.html#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(kknn_wf_fit, <span class="at">file =</span> <span class="st">&quot;_models/kknn_wf_grid.RData&quot;</span>)</span></code></pre></div>

</div>
</div>
<div id="workflow-rpart" class="section level2" number="4.5">
<h2><span class="header-section-number">4.5</span> Workflow: Rpart</h2>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="modeling.html#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb133-2"><a href="modeling.html#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb133-3"><a href="modeling.html#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb133-4"><a href="modeling.html#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb133-5"><a href="modeling.html#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb133-6"><a href="modeling.html#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(discrim)</span>
<span id="cb133-7"><a href="modeling.html#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code></pre></div>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="modeling.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cv 10 folds</span></span>
<span id="cb134-2"><a href="modeling.html#cb134-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-3"><a href="modeling.html#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb134-4"><a href="modeling.html#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To keep speed of processing no repeats will be used during resampling</span></span>
<span id="cb134-5"><a href="modeling.html#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="co"># folds &lt;- vfold_cv(balanced_data, v = 10, repeats = 5)</span></span>
<span id="cb134-6"><a href="modeling.html#cb134-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-7"><a href="modeling.html#cb134-7" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(balanced_data, <span class="at">v =</span> <span class="dv">10</span>)</span></code></pre></div>
<div id="initial-experiment-1" class="section level3" number="4.5.1">
<h3><span class="header-section-number">4.5.1</span> Initial experiment</h3>
<p>Most packages for tree-based models use the formula interface but do not encode the categorical predictors as dummy variables.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="modeling.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. specify the model</span></span>
<span id="cb135-2"><a href="modeling.html#cb135-2" aria-hidden="true" tabindex="-1"></a>tree_model <span class="ot">&lt;-</span> </span>
<span id="cb135-3"><a href="modeling.html#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">decision_tree</span>(<span class="at">min_n =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb135-4"><a href="modeling.html#cb135-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;rpart&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb135-5"><a href="modeling.html#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span>
<span id="cb135-6"><a href="modeling.html#cb135-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-7"><a href="modeling.html#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. preprocessing </span></span>
<span id="cb135-8"><a href="modeling.html#cb135-8" aria-hidden="true" tabindex="-1"></a>preprocess <span class="ot">&lt;-</span> </span>
<span id="cb135-9"><a href="modeling.html#cb135-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(bought <span class="sc">~</span> . , <span class="at">data =</span> balanced_data) <span class="sc">%&gt;%</span></span>
<span id="cb135-10"><a href="modeling.html#cb135-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ratio</span>(<span class="fu">starts_with</span>(<span class="st">&quot;unique_&quot;</span>), <span class="at">denom =</span> <span class="fu">denom_vars</span>(view_qty)) <span class="sc">%&gt;%</span> </span>
<span id="cb135-11"><a href="modeling.html#cb135-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(device_group, unique_product_qty, unique_browse_designer_qty, </span>
<span id="cb135-12"><a href="modeling.html#cb135-12" aria-hidden="true" tabindex="-1"></a>          unique_browse_category_qty) <span class="sc">%&gt;%</span> </span>
<span id="cb135-13"><a href="modeling.html#cb135-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(country, browser_name, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb135-14"><a href="modeling.html#cb135-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(view_qty) <span class="sc">%&gt;%</span></span>
<span id="cb135-15"><a href="modeling.html#cb135-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter</span>(</span>
<span id="cb135-16"><a href="modeling.html#cb135-16" aria-hidden="true" tabindex="-1"></a>    duration <span class="sc">&lt;</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span>,</span>
<span id="cb135-17"><a href="modeling.html#cb135-17" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>((view_qty <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (duration <span class="sc">&lt;=</span> <span class="dv">2</span>))</span>
<span id="cb135-18"><a href="modeling.html#cb135-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb135-19"><a href="modeling.html#cb135-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb135-20"><a href="modeling.html#cb135-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb135-21"><a href="modeling.html#cb135-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">&quot;has_&quot;</span>), <span class="at">num_comp =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb135-22"><a href="modeling.html#cb135-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">5</span>) </span>
<span id="cb135-23"><a href="modeling.html#cb135-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-24"><a href="modeling.html#cb135-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-25"><a href="modeling.html#cb135-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 3, Buildworkflow</span></span>
<span id="cb135-26"><a href="modeling.html#cb135-26" aria-hidden="true" tabindex="-1"></a>tree_wflow <span class="ot">&lt;-</span> </span>
<span id="cb135-27"><a href="modeling.html#cb135-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb135-28"><a href="modeling.html#cb135-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tree_model) <span class="sc">%&gt;%</span> </span>
<span id="cb135-29"><a href="modeling.html#cb135-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preprocess)</span>
<span id="cb135-30"><a href="modeling.html#cb135-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-31"><a href="modeling.html#cb135-31" aria-hidden="true" tabindex="-1"></a><span class="co">#4. Fit model</span></span>
<span id="cb135-32"><a href="modeling.html#cb135-32" aria-hidden="true" tabindex="-1"></a>fit_control <span class="ot">&lt;-</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb135-33"><a href="modeling.html#cb135-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-34"><a href="modeling.html#cb135-34" aria-hidden="true" tabindex="-1"></a>tree_fit <span class="ot">&lt;-</span> </span>
<span id="cb135-35"><a href="modeling.html#cb135-35" aria-hidden="true" tabindex="-1"></a>  tree_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb135-36"><a href="modeling.html#cb135-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(folds, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">control =</span> fit_control)</span></code></pre></div>
<pre><code>## Warning: The `...` are not used in this function but one or more objects were
## passed: &#39;verbose&#39;</code></pre>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="modeling.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">#5. Performance metrics over the validation set</span></span>
<span id="cb137-2"><a href="modeling.html#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(tree_fit)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   .metric  .estimator  mean     n std_err .config             
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;               
## 1 accuracy binary     0.896    10 0.00195 Preprocessor1_Model1
## 2 roc_auc  binary     0.912    10 0.00145 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="modeling.html#cb139-1" aria-hidden="true" tabindex="-1"></a>tree_fit <span class="sc">%&gt;%</span> </span>
<span id="cb139-2"><a href="modeling.html#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb139-3"><a href="modeling.html#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb139-4"><a href="modeling.html#cb139-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(bought, .pred_0) <span class="sc">%&gt;%</span> </span>
<span id="cb139-5"><a href="modeling.html#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="dv">1</span><span class="sc">-</span> specificity, sensitivity, <span class="at">color =</span> id)) <span class="sc">+</span></span>
<span id="cb139-6"><a href="modeling.html#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">&quot;gray80&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb139-7"><a href="modeling.html#cb139-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb139-8"><a href="modeling.html#cb139-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>() <span class="sc">+</span></span>
<span id="cb139-9"><a href="modeling.html#cb139-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-103-1.png" width="672" /></p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="modeling.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># export files</span></span>
<span id="cb140-2"><a href="modeling.html#cb140-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-3"><a href="modeling.html#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tree_fit, <span class="at">file =</span> <span class="st">&quot;_models/tree_fit.RData&quot;</span>)</span></code></pre></div>

</div>
</div>
<div id="workflow-random-forest" class="section level2" number="4.6">
<h2><span class="header-section-number">4.6</span> Workflow: Random Forest</h2>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="modeling.html#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb141-2"><a href="modeling.html#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb141-3"><a href="modeling.html#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb141-4"><a href="modeling.html#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb141-5"><a href="modeling.html#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb141-6"><a href="modeling.html#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(discrim)</span>
<span id="cb141-7"><a href="modeling.html#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code></pre></div>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="modeling.html#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cv 10 folds</span></span>
<span id="cb142-2"><a href="modeling.html#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="modeling.html#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb142-4"><a href="modeling.html#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To keep speed of processing no repeats will be used during resampling</span></span>
<span id="cb142-5"><a href="modeling.html#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="co"># folds &lt;- vfold_cv(balanced_data, v = 10, repeats = 5)</span></span>
<span id="cb142-6"><a href="modeling.html#cb142-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-7"><a href="modeling.html#cb142-7" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(balanced_data, <span class="at">v =</span> <span class="dv">10</span>)</span></code></pre></div>
<div id="initial-experiment-2" class="section level3" number="4.6.1">
<h3><span class="header-section-number">4.6.1</span> Initial experiment</h3>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="modeling.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. specify the model</span></span>
<span id="cb143-2"><a href="modeling.html#cb143-2" aria-hidden="true" tabindex="-1"></a>rand_forest <span class="ot">&lt;-</span></span>
<span id="cb143-3"><a href="modeling.html#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb143-4"><a href="modeling.html#cb143-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;ranger&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb143-5"><a href="modeling.html#cb143-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&#39;classification&#39;</span>)</span>
<span id="cb143-6"><a href="modeling.html#cb143-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-7"><a href="modeling.html#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. preprocessing </span></span>
<span id="cb143-8"><a href="modeling.html#cb143-8" aria-hidden="true" tabindex="-1"></a>preprocess <span class="ot">&lt;-</span> </span>
<span id="cb143-9"><a href="modeling.html#cb143-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(bought <span class="sc">~</span> . , <span class="at">data =</span> balanced_data) <span class="sc">%&gt;%</span></span>
<span id="cb143-10"><a href="modeling.html#cb143-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ratio</span>(<span class="fu">starts_with</span>(<span class="st">&quot;unique_&quot;</span>), <span class="at">denom =</span> <span class="fu">denom_vars</span>(view_qty)) <span class="sc">%&gt;%</span> </span>
<span id="cb143-11"><a href="modeling.html#cb143-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(device_group, unique_product_qty, unique_browse_designer_qty, </span>
<span id="cb143-12"><a href="modeling.html#cb143-12" aria-hidden="true" tabindex="-1"></a>          unique_browse_category_qty) <span class="sc">%&gt;%</span> </span>
<span id="cb143-13"><a href="modeling.html#cb143-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(country, browser_name, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb143-14"><a href="modeling.html#cb143-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(view_qty) <span class="sc">%&gt;%</span></span>
<span id="cb143-15"><a href="modeling.html#cb143-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter</span>(</span>
<span id="cb143-16"><a href="modeling.html#cb143-16" aria-hidden="true" tabindex="-1"></a>    duration <span class="sc">&lt;</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span>,</span>
<span id="cb143-17"><a href="modeling.html#cb143-17" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>((view_qty <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (duration <span class="sc">&lt;=</span> <span class="dv">2</span>))</span>
<span id="cb143-18"><a href="modeling.html#cb143-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb143-19"><a href="modeling.html#cb143-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb143-20"><a href="modeling.html#cb143-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb143-21"><a href="modeling.html#cb143-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">&quot;has_&quot;</span>), <span class="at">num_comp =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb143-22"><a href="modeling.html#cb143-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">5</span>) </span>
<span id="cb143-23"><a href="modeling.html#cb143-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-24"><a href="modeling.html#cb143-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-25"><a href="modeling.html#cb143-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 3, Buildworkflow</span></span>
<span id="cb143-26"><a href="modeling.html#cb143-26" aria-hidden="true" tabindex="-1"></a>forest_wflow <span class="ot">&lt;-</span> </span>
<span id="cb143-27"><a href="modeling.html#cb143-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb143-28"><a href="modeling.html#cb143-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rand_forest) <span class="sc">%&gt;%</span> </span>
<span id="cb143-29"><a href="modeling.html#cb143-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preprocess)</span>
<span id="cb143-30"><a href="modeling.html#cb143-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-31"><a href="modeling.html#cb143-31" aria-hidden="true" tabindex="-1"></a><span class="co">#4. Fit model</span></span>
<span id="cb143-32"><a href="modeling.html#cb143-32" aria-hidden="true" tabindex="-1"></a>fit_control <span class="ot">&lt;-</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb143-33"><a href="modeling.html#cb143-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-34"><a href="modeling.html#cb143-34" aria-hidden="true" tabindex="-1"></a>forest_fit <span class="ot">&lt;-</span> </span>
<span id="cb143-35"><a href="modeling.html#cb143-35" aria-hidden="true" tabindex="-1"></a>  forest_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb143-36"><a href="modeling.html#cb143-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(folds, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">control =</span> fit_control)</span></code></pre></div>
<pre><code>## Warning: The `...` are not used in this function but one or more objects were
## passed: &#39;verbose&#39;</code></pre>
<pre><code>## ! Fold01: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold02: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold03: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold04: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold05: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold06: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold07: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold08: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold09: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<pre><code>## ! Fold10: preprocessor 1/1, model 1/1: 1000 columns were requested but there were ...</code></pre>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="modeling.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co">#5. Performance metrics over the validation set</span></span>
<span id="cb155-2"><a href="modeling.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(forest_fit)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   .metric  .estimator  mean     n std_err .config             
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;               
## 1 accuracy binary     0.924    10 0.00278 Preprocessor1_Model1
## 2 roc_auc  binary     0.972    10 0.00108 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="modeling.html#cb157-1" aria-hidden="true" tabindex="-1"></a>forest_fit <span class="sc">%&gt;%</span> </span>
<span id="cb157-2"><a href="modeling.html#cb157-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb157-3"><a href="modeling.html#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb157-4"><a href="modeling.html#cb157-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(bought, .pred_0) <span class="sc">%&gt;%</span> </span>
<span id="cb157-5"><a href="modeling.html#cb157-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="dv">1</span><span class="sc">-</span> specificity, sensitivity, <span class="at">color =</span> id)) <span class="sc">+</span></span>
<span id="cb157-6"><a href="modeling.html#cb157-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">&quot;gray80&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb157-7"><a href="modeling.html#cb157-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb157-8"><a href="modeling.html#cb157-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>() <span class="sc">+</span></span>
<span id="cb157-9"><a href="modeling.html#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-110-1.png" width="672" /></p>
</div>
<div id="fitting-multiple-models-using-grid-search-1" class="section level3" number="4.6.2">
<h3><span class="header-section-number">4.6.2</span> Fitting multiple models using grid search</h3>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="modeling.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co">#1. list model to inject into workflow</span></span>
<span id="cb158-2"><a href="modeling.html#cb158-2" aria-hidden="true" tabindex="-1"></a>rand_forest_grid <span class="ot">&lt;-</span></span>
<span id="cb158-3"><a href="modeling.html#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="fu">tune</span>(), <span class="at">trees =</span> <span class="fu">tune</span>(), <span class="at">min_n =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb158-4"><a href="modeling.html#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;ranger&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb158-5"><a href="modeling.html#cb158-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&#39;classification&#39;</span>)</span>
<span id="cb158-6"><a href="modeling.html#cb158-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-7"><a href="modeling.html#cb158-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-8"><a href="modeling.html#cb158-8" aria-hidden="true" tabindex="-1"></a>models_flow <span class="ot">&lt;-</span> </span>
<span id="cb158-9"><a href="modeling.html#cb158-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_set</span>(</span>
<span id="cb158-10"><a href="modeling.html#cb158-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">recipe =</span> preprocess),</span>
<span id="cb158-11"><a href="modeling.html#cb158-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> <span class="fu">list</span>(rand_forest_grid),</span>
<span id="cb158-12"><a href="modeling.html#cb158-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cross =</span> <span class="cn">TRUE</span> </span>
<span id="cb158-13"><a href="modeling.html#cb158-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb158-14"><a href="modeling.html#cb158-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-15"><a href="modeling.html#cb158-15" aria-hidden="true" tabindex="-1"></a>forest_wf_fit <span class="ot">&lt;-</span> </span>
<span id="cb158-16"><a href="modeling.html#cb158-16" aria-hidden="true" tabindex="-1"></a>  models_flow <span class="sc">%&gt;%</span></span>
<span id="cb158-17"><a href="modeling.html#cb158-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(</span>
<span id="cb158-18"><a href="modeling.html#cb158-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">fn =</span><span class="st">&quot;tune_grid&quot;</span>,</span>
<span id="cb158-19"><a href="modeling.html#cb158-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds,</span>
<span id="cb158-20"><a href="modeling.html#cb158-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="dv">10</span> ,</span>
<span id="cb158-21"><a href="modeling.html#cb158-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>roc_auc, yardstick<span class="sc">::</span>accuracy, yardstick<span class="sc">::</span>sens),</span>
<span id="cb158-22"><a href="modeling.html#cb158-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb158-23"><a href="modeling.html#cb158-23" aria-hidden="true" tabindex="-1"></a>    ) </span></code></pre></div>
<pre><code>## i 1 of 1 tuning:     recipe_rand_forest</code></pre>
<pre><code>## i Creating pre-processing data to finalize unknown parameter: mtry</code></pre>
<pre><code>## v 1 of 1 tuning:     recipe_rand_forest (26m 25.1s)</code></pre>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="modeling.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(forest_wf_fit) <span class="sc">+</span></span>
<span id="cb162-2"><a href="modeling.html#cb162-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-112-1.png" width="672" /></p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="modeling.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># export files</span></span>
<span id="cb163-2"><a href="modeling.html#cb163-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-3"><a href="modeling.html#cb163-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(forest_fit, <span class="at">file =</span> <span class="st">&quot;_models/forest_fit.RData&quot;</span>)</span>
<span id="cb163-4"><a href="modeling.html#cb163-4" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(forest_wf_fit, <span class="at">file =</span> <span class="st">&quot;_models/forest_wf_grif.RData&quot;</span>)</span></code></pre></div>

</div>
</div>
<div id="workflow-single-layer-neural-network" class="section level2" number="4.7">
<h2><span class="header-section-number">4.7</span> Workflow: Single Layer Neural Network</h2>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="modeling.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb164-2"><a href="modeling.html#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb164-3"><a href="modeling.html#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb164-4"><a href="modeling.html#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb164-5"><a href="modeling.html#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code></pre></div>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="modeling.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cv 10 folds</span></span>
<span id="cb165-2"><a href="modeling.html#cb165-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-3"><a href="modeling.html#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb165-4"><a href="modeling.html#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To keep speed of processing no repeats will be used during resampling</span></span>
<span id="cb165-5"><a href="modeling.html#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="co"># folds &lt;- vfold_cv(balanced_data, v = 10, repeats = 5)</span></span>
<span id="cb165-6"><a href="modeling.html#cb165-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-7"><a href="modeling.html#cb165-7" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(balanced_data, <span class="at">v =</span> <span class="dv">10</span>)</span></code></pre></div>
<div id="initial-experiment-3" class="section level3" number="4.7.1">
<h3><span class="header-section-number">4.7.1</span> Initial experiment</h3>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="modeling.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. specify the model</span></span>
<span id="cb166-2"><a href="modeling.html#cb166-2" aria-hidden="true" tabindex="-1"></a>sl_nnet <span class="ot">&lt;-</span></span>
<span id="cb166-3"><a href="modeling.html#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="cn">NULL</span>, <span class="at">penalty =</span> <span class="cn">NULL</span>, <span class="at">epochs =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb166-4"><a href="modeling.html#cb166-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;nnet&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb166-5"><a href="modeling.html#cb166-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&#39;classification&#39;</span>) </span>
<span id="cb166-6"><a href="modeling.html#cb166-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-7"><a href="modeling.html#cb166-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-8"><a href="modeling.html#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. preprocessing </span></span>
<span id="cb166-9"><a href="modeling.html#cb166-9" aria-hidden="true" tabindex="-1"></a>preprocess <span class="ot">&lt;-</span> </span>
<span id="cb166-10"><a href="modeling.html#cb166-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">recipe</span>(bought <span class="sc">~</span> . , <span class="at">data =</span> balanced_data) <span class="sc">%&gt;%</span></span>
<span id="cb166-11"><a href="modeling.html#cb166-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ratio</span>(<span class="fu">starts_with</span>(<span class="st">&quot;unique_&quot;</span>), <span class="at">denom =</span> <span class="fu">denom_vars</span>(view_qty)) <span class="sc">%&gt;%</span> </span>
<span id="cb166-12"><a href="modeling.html#cb166-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(device_group, unique_product_qty, unique_browse_designer_qty, </span>
<span id="cb166-13"><a href="modeling.html#cb166-13" aria-hidden="true" tabindex="-1"></a>          unique_browse_category_qty) <span class="sc">%&gt;%</span> </span>
<span id="cb166-14"><a href="modeling.html#cb166-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(country, browser_name, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb166-15"><a href="modeling.html#cb166-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(view_qty) <span class="sc">%&gt;%</span></span>
<span id="cb166-16"><a href="modeling.html#cb166-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter</span>(</span>
<span id="cb166-17"><a href="modeling.html#cb166-17" aria-hidden="true" tabindex="-1"></a>    duration <span class="sc">&lt;</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span>,</span>
<span id="cb166-18"><a href="modeling.html#cb166-18" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>((view_qty <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (duration <span class="sc">&lt;=</span> <span class="dv">2</span>))</span>
<span id="cb166-19"><a href="modeling.html#cb166-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb166-20"><a href="modeling.html#cb166-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb166-21"><a href="modeling.html#cb166-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb166-22"><a href="modeling.html#cb166-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">&quot;has_&quot;</span>), <span class="at">num_comp =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb166-23"><a href="modeling.html#cb166-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">5</span>) </span>
<span id="cb166-24"><a href="modeling.html#cb166-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-25"><a href="modeling.html#cb166-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-26"><a href="modeling.html#cb166-26" aria-hidden="true" tabindex="-1"></a>preprocess_mlp_svm <span class="ot">&lt;-</span> </span>
<span id="cb166-27"><a href="modeling.html#cb166-27" aria-hidden="true" tabindex="-1"></a>  preprocess <span class="sc">%&gt;%</span> </span>
<span id="cb166-28"><a href="modeling.html#cb166-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb166-29"><a href="modeling.html#cb166-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb166-30"><a href="modeling.html#cb166-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb166-31"><a href="modeling.html#cb166-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb166-32"><a href="modeling.html#cb166-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-33"><a href="modeling.html#cb166-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-34"><a href="modeling.html#cb166-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 3, Buildworkflow</span></span>
<span id="cb166-35"><a href="modeling.html#cb166-35" aria-hidden="true" tabindex="-1"></a>sl_wflow <span class="ot">&lt;-</span> </span>
<span id="cb166-36"><a href="modeling.html#cb166-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb166-37"><a href="modeling.html#cb166-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(sl_nnet) <span class="sc">%&gt;%</span> </span>
<span id="cb166-38"><a href="modeling.html#cb166-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preprocess_mlp_svm)</span>
<span id="cb166-39"><a href="modeling.html#cb166-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-40"><a href="modeling.html#cb166-40" aria-hidden="true" tabindex="-1"></a><span class="co">#4. Fit model</span></span>
<span id="cb166-41"><a href="modeling.html#cb166-41" aria-hidden="true" tabindex="-1"></a>fit_control <span class="ot">&lt;-</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb166-42"><a href="modeling.html#cb166-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-43"><a href="modeling.html#cb166-43" aria-hidden="true" tabindex="-1"></a>sl_fit <span class="ot">&lt;-</span> </span>
<span id="cb166-44"><a href="modeling.html#cb166-44" aria-hidden="true" tabindex="-1"></a>  sl_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb166-45"><a href="modeling.html#cb166-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb166-46"><a href="modeling.html#cb166-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds, </span>
<span id="cb166-47"><a href="modeling.html#cb166-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>roc_auc, yardstick<span class="sc">::</span>accuracy, yardstick<span class="sc">::</span>sens, yardstick<span class="sc">::</span>specificity),</span>
<span id="cb166-48"><a href="modeling.html#cb166-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb166-49"><a href="modeling.html#cb166-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> fit_control)</span></code></pre></div>
<pre><code>## Warning: The `...` are not used in this function but one or more objects were
## passed: &#39;verbose&#39;</code></pre>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="modeling.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co">#5. Performance metrics over the validation set</span></span>
<span id="cb168-2"><a href="modeling.html#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(sl_fit)</span></code></pre></div>
<pre><code>## # A tibble: 4 x 6
##   .metric     .estimator  mean     n std_err .config             
##   &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;               
## 1 accuracy    binary     0.911    10 0.00329 Preprocessor1_Model1
## 2 roc_auc     binary     0.963    10 0.00184 Preprocessor1_Model1
## 3 sens        binary     0.872    10 0.00596 Preprocessor1_Model1
## 4 specificity binary     0.950    10 0.00319 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="modeling.html#cb170-1" aria-hidden="true" tabindex="-1"></a>sl_fit <span class="sc">%&gt;%</span> </span>
<span id="cb170-2"><a href="modeling.html#cb170-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb170-3"><a href="modeling.html#cb170-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb170-4"><a href="modeling.html#cb170-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(bought, .pred_0) <span class="sc">%&gt;%</span> </span>
<span id="cb170-5"><a href="modeling.html#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="dv">1</span><span class="sc">-</span> specificity, sensitivity, <span class="at">color =</span> id)) <span class="sc">+</span></span>
<span id="cb170-6"><a href="modeling.html#cb170-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">&quot;gray80&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb170-7"><a href="modeling.html#cb170-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb170-8"><a href="modeling.html#cb170-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>() <span class="sc">+</span></span>
<span id="cb170-9"><a href="modeling.html#cb170-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-119-1.png" width="672" /></p>
</div>
<div id="fitting-multiple-models-using-grid-search-2" class="section level3" number="4.7.2">
<h3><span class="header-section-number">4.7.2</span> Fitting multiple models using grid search</h3>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="modeling.html#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co">#1. list model to inject into workflow</span></span>
<span id="cb171-2"><a href="modeling.html#cb171-2" aria-hidden="true" tabindex="-1"></a>sl_nnet <span class="ot">&lt;-</span></span>
<span id="cb171-3"><a href="modeling.html#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="fu">tune</span>(), <span class="at">penalty =</span> <span class="fu">tune</span>(), <span class="at">epochs =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb171-4"><a href="modeling.html#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;nnet&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb171-5"><a href="modeling.html#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&#39;classification&#39;</span>)</span>
<span id="cb171-6"><a href="modeling.html#cb171-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-7"><a href="modeling.html#cb171-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-8"><a href="modeling.html#cb171-8" aria-hidden="true" tabindex="-1"></a>models_flow <span class="ot">&lt;-</span> </span>
<span id="cb171-9"><a href="modeling.html#cb171-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_set</span>(</span>
<span id="cb171-10"><a href="modeling.html#cb171-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">recipe =</span> preprocess_mlp_svm),</span>
<span id="cb171-11"><a href="modeling.html#cb171-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> <span class="fu">list</span>(sl_nnet),</span>
<span id="cb171-12"><a href="modeling.html#cb171-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cross =</span> <span class="cn">TRUE</span> </span>
<span id="cb171-13"><a href="modeling.html#cb171-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb171-14"><a href="modeling.html#cb171-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-15"><a href="modeling.html#cb171-15" aria-hidden="true" tabindex="-1"></a>nn_wf_fit <span class="ot">&lt;-</span> </span>
<span id="cb171-16"><a href="modeling.html#cb171-16" aria-hidden="true" tabindex="-1"></a>  models_flow <span class="sc">%&gt;%</span></span>
<span id="cb171-17"><a href="modeling.html#cb171-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(</span>
<span id="cb171-18"><a href="modeling.html#cb171-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">fn =</span><span class="st">&quot;tune_grid&quot;</span>,</span>
<span id="cb171-19"><a href="modeling.html#cb171-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds,</span>
<span id="cb171-20"><a href="modeling.html#cb171-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="dv">10</span> ,</span>
<span id="cb171-21"><a href="modeling.html#cb171-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>roc_auc, yardstick<span class="sc">::</span>sens, yardstick<span class="sc">::</span>accuracy,yardstick<span class="sc">::</span>spec),</span>
<span id="cb171-22"><a href="modeling.html#cb171-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb171-23"><a href="modeling.html#cb171-23" aria-hidden="true" tabindex="-1"></a>    ) </span></code></pre></div>
<pre><code>## i 1 of 1 tuning:     recipe_mlp</code></pre>
<pre><code>## v 1 of 1 tuning:     recipe_mlp (14m 45.8s)</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="modeling.html#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(nn_wf_fit) <span class="sc">+</span></span>
<span id="cb174-2"><a href="modeling.html#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-121-1.png" width="672" /></p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="modeling.html#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(nn_wf_fit, <span class="at">select_best =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb175-2"><a href="modeling.html#cb175-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-122-1.png" width="672" /></p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="modeling.html#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rank_results</span>(nn_wf_fit, <span class="at">rank_metric =</span> <span class="st">&quot;sens&quot;</span>, <span class="at">select_best =</span> <span class="cn">TRUE</span>) </span></code></pre></div>
<pre><code>## # A tibble: 4 x 9
##   wflow_id   .config        .metric  mean std_err     n preprocessor model  rank
##   &lt;chr&gt;      &lt;fct&gt;          &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;        &lt;chr&gt; &lt;int&gt;
## 1 recipe_mlp Preprocessor1~ accura~ 0.913 0.00334    10 recipe       mlp       1
## 2 recipe_mlp Preprocessor1~ roc_auc 0.967 0.00204    10 recipe       mlp       1
## 3 recipe_mlp Preprocessor1~ sens    0.888 0.00452    10 recipe       mlp       1
## 4 recipe_mlp Preprocessor1~ spec    0.939 0.00368    10 recipe       mlp       1</code></pre>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="modeling.html#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># export files</span></span>
<span id="cb178-2"><a href="modeling.html#cb178-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-3"><a href="modeling.html#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(sl_fit, <span class="at">file =</span> <span class="st">&quot;_models/sl_fit.RData&quot;</span>)</span>
<span id="cb178-4"><a href="modeling.html#cb178-4" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(nn_wf_fit, <span class="at">file =</span> <span class="st">&quot;_models/nn_wf_fit.RData&quot;</span>)</span></code></pre></div>

</div>
</div>
<div id="support-vector-machine" class="section level2" number="4.8">
<h2><span class="header-section-number">4.8</span> Support Vector Machine</h2>
<div id="initial-experience-linear-kernel" class="section level3" number="4.8.1">
<h3><span class="header-section-number">4.8.1</span> Initial experience: Linear Kernel</h3>
<p>A Linear Kernel with default parameters will be used as the basis for</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="modeling.html#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. specify the model</span></span>
<span id="cb179-2"><a href="modeling.html#cb179-2" aria-hidden="true" tabindex="-1"></a>svm_linear <span class="ot">&lt;-</span></span>
<span id="cb179-3"><a href="modeling.html#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svm_linear</span>(<span class="at">cost =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-4"><a href="modeling.html#cb179-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;kernlab&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-5"><a href="modeling.html#cb179-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span>
<span id="cb179-6"><a href="modeling.html#cb179-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-7"><a href="modeling.html#cb179-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-8"><a href="modeling.html#cb179-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. preprocessing </span></span>
<span id="cb179-9"><a href="modeling.html#cb179-9" aria-hidden="true" tabindex="-1"></a>preprocess <span class="ot">&lt;-</span> </span>
<span id="cb179-10"><a href="modeling.html#cb179-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(bought <span class="sc">~</span> . , <span class="at">data =</span> balanced_data) <span class="sc">%&gt;%</span></span>
<span id="cb179-11"><a href="modeling.html#cb179-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ratio</span>(<span class="fu">starts_with</span>(<span class="st">&quot;unique_&quot;</span>), <span class="at">denom =</span> <span class="fu">denom_vars</span>(view_qty)) <span class="sc">%&gt;%</span> </span>
<span id="cb179-12"><a href="modeling.html#cb179-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(device_group, unique_product_qty, unique_browse_designer_qty, </span>
<span id="cb179-13"><a href="modeling.html#cb179-13" aria-hidden="true" tabindex="-1"></a>          unique_browse_category_qty) <span class="sc">%&gt;%</span> </span>
<span id="cb179-14"><a href="modeling.html#cb179-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(country, browser_name, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-15"><a href="modeling.html#cb179-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(view_qty) <span class="sc">%&gt;%</span></span>
<span id="cb179-16"><a href="modeling.html#cb179-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_filter</span>(</span>
<span id="cb179-17"><a href="modeling.html#cb179-17" aria-hidden="true" tabindex="-1"></a>    duration <span class="sc">&lt;</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span>,</span>
<span id="cb179-18"><a href="modeling.html#cb179-18" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>((view_qty <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (duration <span class="sc">&lt;=</span> <span class="dv">2</span>))</span>
<span id="cb179-19"><a href="modeling.html#cb179-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb179-20"><a href="modeling.html#cb179-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb179-21"><a href="modeling.html#cb179-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb179-22"><a href="modeling.html#cb179-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">&quot;has_&quot;</span>), <span class="at">num_comp =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-23"><a href="modeling.html#cb179-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">5</span>) </span>
<span id="cb179-24"><a href="modeling.html#cb179-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-25"><a href="modeling.html#cb179-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-26"><a href="modeling.html#cb179-26" aria-hidden="true" tabindex="-1"></a>preprocess_mlp_svm <span class="ot">&lt;-</span> </span>
<span id="cb179-27"><a href="modeling.html#cb179-27" aria-hidden="true" tabindex="-1"></a>  preprocess <span class="sc">%&gt;%</span> </span>
<span id="cb179-28"><a href="modeling.html#cb179-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb179-29"><a href="modeling.html#cb179-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb179-30"><a href="modeling.html#cb179-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb179-31"><a href="modeling.html#cb179-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) </span>
<span id="cb179-32"><a href="modeling.html#cb179-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-33"><a href="modeling.html#cb179-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 3, Buildworkflow</span></span>
<span id="cb179-34"><a href="modeling.html#cb179-34" aria-hidden="true" tabindex="-1"></a>svm_linear_wflow <span class="ot">&lt;-</span> </span>
<span id="cb179-35"><a href="modeling.html#cb179-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb179-36"><a href="modeling.html#cb179-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(svm_linear) <span class="sc">%&gt;%</span> </span>
<span id="cb179-37"><a href="modeling.html#cb179-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preprocess_mlp_svm)</span>
<span id="cb179-38"><a href="modeling.html#cb179-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-39"><a href="modeling.html#cb179-39" aria-hidden="true" tabindex="-1"></a><span class="co">#4. Fit model</span></span>
<span id="cb179-40"><a href="modeling.html#cb179-40" aria-hidden="true" tabindex="-1"></a>fit_control <span class="ot">&lt;-</span> <span class="fu">control_grid</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb179-41"><a href="modeling.html#cb179-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-42"><a href="modeling.html#cb179-42" aria-hidden="true" tabindex="-1"></a>svm_linear_fit <span class="ot">&lt;-</span> </span>
<span id="cb179-43"><a href="modeling.html#cb179-43" aria-hidden="true" tabindex="-1"></a>  svm_linear_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb179-44"><a href="modeling.html#cb179-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb179-45"><a href="modeling.html#cb179-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds, </span>
<span id="cb179-46"><a href="modeling.html#cb179-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb179-47"><a href="modeling.html#cb179-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>roc_auc, yardstick<span class="sc">::</span>accuracy, yardstick<span class="sc">::</span>sens,yardstick<span class="sc">::</span>specificity),</span>
<span id="cb179-48"><a href="modeling.html#cb179-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> fit_control)</span></code></pre></div>
<pre><code>## Warning: The `...` are not used in this function but one or more objects were
## passed: &#39;verbose&#39;</code></pre>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="modeling.html#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co">#5. Performance metrics over the validation set</span></span>
<span id="cb181-2"><a href="modeling.html#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(svm_linear_fit)</span></code></pre></div>
<pre><code>## # A tibble: 4 x 6
##   .metric     .estimator  mean     n std_err .config             
##   &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;               
## 1 accuracy    binary     0.805    10 0.00403 Preprocessor1_Model1
## 2 roc_auc     binary     0.919    10 0.00202 Preprocessor1_Model1
## 3 sens        binary     0.673    10 0.00733 Preprocessor1_Model1
## 4 specificity binary     0.937    10 0.00215 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="modeling.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat_resampled</span>(svm_linear_fit)</span></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##   Prediction Truth  Freq
##   &lt;fct&gt;      &lt;fct&gt; &lt;dbl&gt;
## 1 0          0     538. 
## 2 0          1      50.2
## 3 1          0     262. 
## 4 1          1     750.</code></pre>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="modeling.html#cb185-1" aria-hidden="true" tabindex="-1"></a>svm_linear_fit <span class="sc">%&gt;%</span> </span>
<span id="cb185-2"><a href="modeling.html#cb185-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb185-3"><a href="modeling.html#cb185-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb185-4"><a href="modeling.html#cb185-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(bought, .pred_0) <span class="sc">%&gt;%</span> </span>
<span id="cb185-5"><a href="modeling.html#cb185-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="dv">1</span><span class="sc">-</span> specificity, sensitivity, <span class="at">color =</span> id)) <span class="sc">+</span></span>
<span id="cb185-6"><a href="modeling.html#cb185-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">&quot;gray80&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb185-7"><a href="modeling.html#cb185-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb185-8"><a href="modeling.html#cb185-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>() <span class="sc">+</span></span>
<span id="cb185-9"><a href="modeling.html#cb185-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-131-1.png" width="672" /></p>
</div>
<div id="fitting-multiple-models" class="section level3" number="4.8.2">
<h3><span class="header-section-number">4.8.2</span> Fitting multiple models</h3>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="modeling.html#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co">#1. list model to inject into workflow</span></span>
<span id="cb186-2"><a href="modeling.html#cb186-2" aria-hidden="true" tabindex="-1"></a>svm_linear <span class="ot">&lt;-</span></span>
<span id="cb186-3"><a href="modeling.html#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svm_rbf</span>(<span class="at">cost =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb186-4"><a href="modeling.html#cb186-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;kernlab&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb186-5"><a href="modeling.html#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span>
<span id="cb186-6"><a href="modeling.html#cb186-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-7"><a href="modeling.html#cb186-7" aria-hidden="true" tabindex="-1"></a>svm_poly_kernlab_spec <span class="ot">&lt;-</span></span>
<span id="cb186-8"><a href="modeling.html#cb186-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svm_poly</span>(<span class="at">cost =</span> <span class="fu">tune</span>(), <span class="at">degree =</span> <span class="fu">tune</span>(), <span class="at">scale_factor =</span> <span class="fu">tune</span>(), <span class="at">margin =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb186-9"><a href="modeling.html#cb186-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;kernlab&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb186-10"><a href="modeling.html#cb186-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&#39;classification&#39;</span>)</span>
<span id="cb186-11"><a href="modeling.html#cb186-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-12"><a href="modeling.html#cb186-12" aria-hidden="true" tabindex="-1"></a>svm_rbf_kernlab_spec <span class="ot">&lt;-</span></span>
<span id="cb186-13"><a href="modeling.html#cb186-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svm_rbf</span>(<span class="at">cost =</span> <span class="fu">tune</span>(), <span class="at">rbf_sigma =</span> <span class="fu">tune</span>(), <span class="at">margin =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb186-14"><a href="modeling.html#cb186-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&#39;kernlab&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb186-15"><a href="modeling.html#cb186-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&#39;classification&#39;</span>)</span>
<span id="cb186-16"><a href="modeling.html#cb186-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-17"><a href="modeling.html#cb186-17" aria-hidden="true" tabindex="-1"></a>models_flow <span class="ot">&lt;-</span> </span>
<span id="cb186-18"><a href="modeling.html#cb186-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_set</span>(</span>
<span id="cb186-19"><a href="modeling.html#cb186-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">recipe =</span> preprocess_mlp_svm),</span>
<span id="cb186-20"><a href="modeling.html#cb186-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">models =</span> <span class="fu">list</span>(<span class="at">svm_ploy =</span> svm_poly_kernlab_spec, <span class="at">svm_rbf =</span> svm_rbf_kernlab_spec, <span class="at">linear =</span> svm_linear),</span>
<span id="cb186-21"><a href="modeling.html#cb186-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">cross =</span> <span class="cn">TRUE</span> </span>
<span id="cb186-22"><a href="modeling.html#cb186-22" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="modeling.html#cb187-1" aria-hidden="true" tabindex="-1"></a>svm_wf_fit <span class="ot">&lt;-</span> </span>
<span id="cb187-2"><a href="modeling.html#cb187-2" aria-hidden="true" tabindex="-1"></a>  models_flow <span class="sc">%&gt;%</span></span>
<span id="cb187-3"><a href="modeling.html#cb187-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(</span>
<span id="cb187-4"><a href="modeling.html#cb187-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fn =</span><span class="st">&quot;tune_grid&quot;</span>,</span>
<span id="cb187-5"><a href="modeling.html#cb187-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds,</span>
<span id="cb187-6"><a href="modeling.html#cb187-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="dv">5</span>,</span>
<span id="cb187-7"><a href="modeling.html#cb187-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>roc_auc, yardstick<span class="sc">::</span>accuracy, yardstick<span class="sc">::</span>sens, yardstick<span class="sc">::</span>spec),</span>
<span id="cb187-8"><a href="modeling.html#cb187-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb187-9"><a href="modeling.html#cb187-9" aria-hidden="true" tabindex="-1"></a>    ) </span></code></pre></div>
<pre><code>## i 1 of 3 tuning:     recipe_svm_ploy</code></pre>
<pre><code>## v 1 of 3 tuning:     recipe_svm_ploy (7m 34.9s)</code></pre>
<pre><code>## i 2 of 3 tuning:     recipe_svm_rbf</code></pre>
<pre><code>## v 2 of 3 tuning:     recipe_svm_rbf (14m 37.1s)</code></pre>
<pre><code>## i 3 of 3 tuning:     recipe_linear</code></pre>
<pre><code>## v 3 of 3 tuning:     recipe_linear (12m 17.3s)</code></pre>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="modeling.html#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(svm_wf_fit) <span class="sc">+</span></span>
<span id="cb194-2"><a href="modeling.html#cb194-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-134-1.png" width="672" /></p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="modeling.html#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(svm_wf_fit, <span class="at">select_best =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb195-2"><a href="modeling.html#cb195-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_masterDS</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-135-1.png" width="672" /></p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="modeling.html#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rank_results</span>(svm_wf_fit, <span class="at">rank_metric =</span> <span class="st">&quot;sens&quot;</span>, <span class="at">select_best =</span> <span class="cn">TRUE</span>) </span></code></pre></div>
<pre><code>## # A tibble: 12 x 9
##    wflow_id        .config  .metric  mean std_err     n preprocessor model  rank
##    &lt;chr&gt;           &lt;fct&gt;    &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;        &lt;chr&gt; &lt;int&gt;
##  1 recipe_linear   Preproc~ accura~ 0.891 0.00294     9 recipe       svm_~     1
##  2 recipe_linear   Preproc~ roc_auc 0.952 0.00224     9 recipe       svm_~     1
##  3 recipe_linear   Preproc~ sens    0.840 0.00602     9 recipe       svm_~     1
##  4 recipe_linear   Preproc~ spec    0.943 0.00231     9 recipe       svm_~     1
##  5 recipe_svm_ploy Preproc~ accura~ 0.879 0.00314    10 recipe       svm_~     2
##  6 recipe_svm_ploy Preproc~ roc_auc 0.949 0.00228    10 recipe       svm_~     2
##  7 recipe_svm_ploy Preproc~ sens    0.820 0.00548    10 recipe       svm_~     2
##  8 recipe_svm_ploy Preproc~ spec    0.938 0.00284    10 recipe       svm_~     2
##  9 recipe_svm_rbf  Preproc~ accura~ 0.783 0.00446    10 recipe       svm_~     3
## 10 recipe_svm_rbf  Preproc~ roc_auc 0.919 0.00192    10 recipe       svm_~     3
## 11 recipe_svm_rbf  Preproc~ sens    0.595 0.00657    10 recipe       svm_~     3
## 12 recipe_svm_rbf  Preproc~ spec    0.972 0.00143    10 recipe       svm_~     3</code></pre>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="modeling.html#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rank_results</span>(svm_wf_fit, <span class="at">rank_metric =</span> <span class="st">&quot;accuracy&quot;</span>, <span class="at">select_best =</span> <span class="cn">TRUE</span>) </span></code></pre></div>
<pre><code>## # A tibble: 12 x 9
##    wflow_id        .config  .metric  mean std_err     n preprocessor model  rank
##    &lt;chr&gt;           &lt;fct&gt;    &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;        &lt;chr&gt; &lt;int&gt;
##  1 recipe_linear   Preproc~ accura~ 0.891 0.00294     9 recipe       svm_~     1
##  2 recipe_linear   Preproc~ roc_auc 0.952 0.00224     9 recipe       svm_~     1
##  3 recipe_linear   Preproc~ sens    0.840 0.00602     9 recipe       svm_~     1
##  4 recipe_linear   Preproc~ spec    0.943 0.00231     9 recipe       svm_~     1
##  5 recipe_svm_ploy Preproc~ accura~ 0.879 0.00314    10 recipe       svm_~     2
##  6 recipe_svm_ploy Preproc~ roc_auc 0.949 0.00228    10 recipe       svm_~     2
##  7 recipe_svm_ploy Preproc~ sens    0.820 0.00548    10 recipe       svm_~     2
##  8 recipe_svm_ploy Preproc~ spec    0.938 0.00284    10 recipe       svm_~     2
##  9 recipe_svm_rbf  Preproc~ accura~ 0.783 0.00446    10 recipe       svm_~     3
## 10 recipe_svm_rbf  Preproc~ roc_auc 0.919 0.00192    10 recipe       svm_~     3
## 11 recipe_svm_rbf  Preproc~ sens    0.595 0.00657    10 recipe       svm_~     3
## 12 recipe_svm_rbf  Preproc~ spec    0.972 0.00143    10 recipe       svm_~     3</code></pre>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="modeling.html#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(svm_wf_fit, <span class="at">metric =</span> <span class="st">&quot;accuracy&quot;</span>,<span class="at">id =</span> <span class="st">&quot;recipe_svm_ploy&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-138-1.png" width="672" /></p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="modeling.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># export files</span></span>
<span id="cb201-2"><a href="modeling.html#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(svm_wf_fit,<span class="at">file=</span><span class="st">&quot;_models/svm_wf_fit.RData&quot;</span>)</span>
<span id="cb201-3"><a href="modeling.html#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(svm_linear_fit, <span class="at">file =</span> <span class="st">&quot;_models/svm_linear_fit.RData&quot;</span>)</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-transformations.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="evaluation-and-conclusion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/04-modeling.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
