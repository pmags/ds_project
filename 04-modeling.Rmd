---
title: "R Notebook"
output: html_notebook
---

# Modeling

```{r libraries}
# libraries
library(tidyverse)
library(tidymodels)
library(keras)
library(workflowsets)
library(discrim)
library(factoextra)

```

```{r data preprocess, message=TRUE, warning=FALSE, include=FALSE}
# import data and prepocess

# import and prepare data
# import data
unbalanced_data <- read_csv("./data/train_full.csv") %>% 
  select(-...1, -session_id) %>% 
  mutate(bought = as.factor(bought))
balanced_data <- read_csv("./data/train_balanced.csv") %>% 
  select(-...1, -session_id) %>% 
  mutate(bought = as.factor(bought))

```

```{r resampling folds, message=TRUE, warning=FALSE}

# cv 10 folds

set.seed(1234)
# To keep speed of processing no repeats will be used during resampling
# folds <- vfold_cv(balanced_data, v = 10, repeats = 5)

folds <- vfold_cv(balanced_data, v = 10)


```

The following planning will be used for a list of candidate models:

1. A Model baseline will be defined and will be used to compare against other models
2. Define training and evaluation series. Using Cross Validation with 10 folds
3. Initial experiment using preprocessing workflow
4. When needed given this project objectives hyperparameters will be tuned
5. Retrain model with new hyperparameters
6. Model comparisson

Given the goals set for this project we shall focus on Accuracy and Auc ROC as metricas to compare models. 

The initial experiment uses the preprocess schema and the default hyperparameters for each model.


## Baseline

Given its simplicity and flexibility a Naive Bayes classifier will be used as baseline for this project. The preprocess was set to a minimum in order to measure the impact it might have on the final output. The engine used for this algorithm does not accept missing data, therefore we did a 3nn imputation.

```{r}

# 1. specify the model
naive_Bayes <-
  discrim::naive_Bayes() %>%
  set_engine('klaR')

# 2. preprocessing 
preprocess <- 
  recipe(bought ~ ., data = balanced_data) %>%
  step_string2factor(all_nominal_predictors()) %>% 
  step_impute_knn(all_predictors(), neighbors = 3) %>%
  step_scale(all_numeric_predictors())
  

# 3, Buildworkflow
baseline_wflow <- 
  workflow() %>% 
  add_model(naive_Bayes) %>% 
  add_recipe(preprocess)

#4. Fit model
fit_control <- control_resamples(save_pred = TRUE, save_workflow = TRUE)

baseline_fit <- 
  baseline_wflow %>% 
  fit_resamples(folds, verbose = TRUE, control = fit_control)


#5. Performance metrics over the validation set
collect_metrics(baseline_fit)

```

```{r}

conf_mat_resampled(baseline_fit)

```

```{r}

svm_linear_fit %>% 
  collect_predictions() %>% 
  group_by(id) %>% 
  roc_curve(bought, .pred_0) %>% 
  ggplot(aes(1- specificity, sensitivity, color = id)) +
  geom_abline(lty = 3, color = "gray80", size = 1) +
  geom_path(show.legend = FALSE, alpha = 0.6, size = 1.2) +
  theme_masterDS() +
  coord_equal()

```











